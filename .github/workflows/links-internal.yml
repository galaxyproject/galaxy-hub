name: Check Internal Links
on:
  workflow_dispatch:
  # Disabled: Gridsome build no longer maintained on master. Needs Astro equivalent.
  # schedule:
  #   - cron: "30 23 * * *"
env:
  NODE_OPTIONS: --max-old-space-size=4096
jobs:
  check_links_internal:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: astro
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: astro/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Build site
        run: npm run build
      - name: Serve and Check Links
        run: npx astro preview & (sleep 5 && npm run links:internal)
      - name: Create Issue From File
        uses: peter-evans/create-issue-from-file@v5
        with:
          issue-number: 860
          title: Internal Link Checker Report (updated daily)
          content-filepath: astro/broken-links.md
          labels: report, automated issue
