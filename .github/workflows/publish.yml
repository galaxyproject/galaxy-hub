name: Publish Hub (Gridsome)
on:
  workflow_dispatch:
  push:
    branches:
      - gridsome-publish
concurrency:
  group: publish-gridsome
env:
  NODE_OPTIONS: --max-old-space-size=4096
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'yarn'
      - name: Install project dependencies
        run: yarn --prefer-offline
      - name: Build Gridsome site
        run: yarn build
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      - name: Sync Gridsome to S3
        run: aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET }}/ --delete --acl public-read --follow-symlinks
      - name: Invalidate CloudFront cache for feeds
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/events/feed.json" "/news/feed.json" \
            --region us-east-1
      - name: Wait for cache invalidation
        run: sleep 90

  # TODO: Re-enable galaxy-social-assistant on master's publish.yml after
  # production cutover to Astro. The days parameter and content detection
  # logic should move back there once Astro is deploying to galaxyproject.org.
  # galaxy-social-assistant:
  #   needs: publish
  #   if: github.event_name == 'push' && needs.publish.outputs.has_new_content == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Create Galaxy Social Assistant Token
  #       uses: actions/create-github-app-token@v2
  #       id: galaxy-social-assistant-token
  #       with:
  #         app-id: ${{ vars.GALAXY_SOCIAL_ASSISTANT_APP_ID }}
  #         private-key: ${{ secrets.GALAXY_SOCIAL_ASSISTANT_PRIVATE_KEY }}
  #         owner: "usegalaxy-eu"
  #         repositories: "galaxy-social-assistant"
  #     - name: Trigger Galaxy Social Assistant
  #       uses: benc-uk/workflow-dispatch@v1
  #       with:
  #         workflow: feed_bot.yml
  #         repo: usegalaxy-eu/galaxy-social-assistant
  #         token: ${{ steps.galaxy-social-assistant-token.outputs.token }}
  #         ref: main
  #         inputs: '{"days": "1"}'
