---
/**
 * ESG Events Page
 * Lists events tagged with ESG or EU subsite
 */
import ESGLayout from '../../../layouts/ESGLayout.astro';
import { getCollection } from 'astro:content';

// Check for solo mode
const solo = Astro.url.searchParams.get('solo') === 'true';

// Load ESG events
const events = await getCollection('events');
const now = new Date();

const allEsgEvents = events
  .filter(e => {
    const subsites = e.data.subsites || [];
    return subsites.includes('esg') || subsites.includes('eu');
  })
  .sort((a, b) => {
    const dateA = new Date(a.data.date || 0);
    const dateB = new Date(b.data.date || 0);
    return dateA.getTime() - dateB.getTime();
  });

const upcomingEvents = allEsgEvents.filter(e => new Date(e.data.date || 0) >= now);
const pastEvents = allEsgEvents
  .filter(e => new Date(e.data.date || 0) < now)
  .reverse()
  .slice(0, 20);

function formatDate(date: Date | string | undefined): string {
  if (!date) return '';
  const d = typeof date === 'string' ? new Date(date) : date;
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function formatDateRange(start: Date | string | undefined, end: Date | string | undefined): string {
  if (!start) return '';
  const startDate = typeof start === 'string' ? new Date(start) : start;
  const endDate = end ? (typeof end === 'string' ? new Date(end) : end) : null;

  if (!endDate || startDate.getTime() === endDate.getTime()) {
    return formatDate(startDate);
  }

  return `${formatDate(startDate)} - ${formatDate(endDate)}`;
}

function esgUrl(path: string): string {
  return solo ? `${path}?solo=true` : path;
}
---

<ESGLayout title="Events" description="Upcoming and past events from the EuroScienceGateway project" solo={solo}>
  <div class="mb-6">
    <a href={esgUrl('/projects/esg/')} class="text-blue-600 hover:underline text-sm">
      &larr; Back to ESG Home
    </a>
  </div>

  <h1 class="text-3xl font-light text-gray-800 mb-8">EuroScienceGateway Events</h1>

  <!-- Upcoming Events -->
  <section class="mb-12">
    <h2 class="text-2xl font-light text-gray-700 mb-6 flex items-center gap-2">
      <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      Upcoming Events
    </h2>

    {upcomingEvents.length > 0 ? (
      <div class="space-y-4">
        {upcomingEvents.map(event => (
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex flex-col md:flex-row md:items-start gap-4">
              <div class="text-blue-600 font-medium whitespace-nowrap">
                {formatDateRange(event.data.date, event.data.end)}
              </div>
              <div class="flex-1">
                <a href={`/events/${event.data.slug}/`} class="text-lg font-medium text-gray-800 hover:text-blue-600">
                  {event.data.title}
                </a>
                {event.data.location && (
                  <p class="text-sm text-gray-500 mt-1">{event.data.location}</p>
                )}
                {event.data.tease && (
                  <p class="text-gray-600 mt-2 text-sm">{event.data.tease}</p>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p class="text-gray-500">No upcoming events at this time.</p>
    )}
  </section>

  <!-- Past Events -->
  {pastEvents.length > 0 && (
    <section>
      <h2 class="text-2xl font-light text-gray-700 mb-6">Past Events</h2>
      <div class="space-y-3">
        {pastEvents.map(event => (
          <div class="border-b border-gray-100 pb-3">
            <div class="flex flex-col md:flex-row md:items-center gap-2">
              <span class="text-gray-500 text-sm whitespace-nowrap">
                {formatDate(event.data.date)}
              </span>
              <a href={`/events/${event.data.slug}/`} class="text-gray-700 hover:text-blue-600">
                {event.data.title}
              </a>
            </div>
          </div>
        ))}
      </div>
    </section>
  )}
</ESGLayout>
