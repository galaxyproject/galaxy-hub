---
/**
 * Dynamic route for platform pages (Galaxy servers)
 */
import { getCollection, render } from 'astro:content';
import PlatformLayout from '../../layouts/PlatformLayout.astro';

// Import MDX components for embedded content
import VegaEmbed from '../../components/mdx/VegaEmbed.astro';
import Twitter from '../../components/mdx/Twitter.astro';
import Mastodon from '../../components/mdx/Mastodon.astro';
import VideoPlayer from '../../components/mdx/VideoPlayer.astro';
import Carousel from '../../components/mdx/Carousel.astro';
import CalendarEmbed from '../../components/mdx/CalendarEmbed.astro';
import MarkdownEmbed from '../../components/mdx/MarkdownEmbed.astro';
import Flickr from '../../components/mdx/Flickr.astro';
import Supporters from '../../components/mdx/Supporters.astro';
import Contacts from '../../components/mdx/Contacts.astro';
import Insert from '../../components/mdx/Insert.astro';

export async function getStaticPaths() {
  const platforms = await getCollection('platforms');

  return platforms.map(platform => {
    // Remove 'use/' prefix from slug for the URL
    const urlSlug = platform.data.slug.replace(/^use\//, '');
    return {
      params: { slug: urlSlug },
      props: { platform },
    };
  });
}

const { platform } = Astro.props;
const { Content } = await render(platform);

const {
  title,
  url,
  image,
  summary,
  scope,
  platforms: instances,
  comments,
  user_support,
  quotas,
  citations,
  pub_libraries,
  sponsors,
  tags,
} = platform.data;

// Normalize tags to array
const tagList = Array.isArray(tags) ? tags : (tags ? [tags] : []);

// MDX components map
const components = {
  VegaEmbed,
  Twitter,
  Mastodon,
  VideoPlayer,
  Carousel,
  CalendarEmbed,
  MarkdownEmbed,
  Flickr,
  Supporters,
  Contacts,
  Insert,
};
---

<PlatformLayout
  title={title || 'Galaxy Server'}
  url={url}
  image={image}
  summary={summary}
  scope={scope}
  platforms={instances}
  comments={comments}
  user_support={user_support}
  quotas={quotas}
  citations={citations}
  pub_libraries={pub_libraries}
  sponsors={sponsors}
  tags={tagList}
>
  <Content components={components} />
</PlatformLayout>
