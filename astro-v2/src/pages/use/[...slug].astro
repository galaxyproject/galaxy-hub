---
/**
 * Dynamic route for platform pages (Galaxy servers)
 */
import { getCollection, render } from 'astro:content';
import PlatformLayout from '../../layouts/PlatformLayout.astro';

export async function getStaticPaths() {
  const platforms = await getCollection('platforms');

  return platforms.map(platform => {
    // Remove 'use/' prefix from slug for the URL
    const urlSlug = platform.data.slug.replace(/^use\//, '');
    return {
      params: { slug: urlSlug },
      props: { platform },
    };
  });
}

const { platform } = Astro.props;
const { Content } = await render(platform);

const {
  title,
  url,
  image,
  summary,
  scope,
  platforms: instances,
  comments,
  user_support,
  quotas,
  citations,
  pub_libraries,
  sponsors,
  tags,
} = platform.data;

// Normalize tags to array
const tagList = Array.isArray(tags) ? tags : (tags ? [tags] : []);
---

<PlatformLayout
  title={title || 'Galaxy Server'}
  url={url}
  image={image}
  summary={summary}
  scope={scope}
  platforms={instances}
  comments={comments}
  user_support={user_support}
  quotas={quotas}
  citations={citations}
  pub_libraries={pub_libraries}
  sponsors={sponsors}
  tags={tagList}
>
  <Content />
</PlatformLayout>
