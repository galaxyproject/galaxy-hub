---
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { subsites } from '../../stores/subsiteStore';
import { Cite } from '@citation-js/core';
import '@citation-js/plugin-bibtex';

// Generate paths for all non-external subsites
export function getStaticPaths() {
  return subsites
    .filter((s) => s.id !== 'global' && !('external' in s && s.external))
    .map((s) => ({
      params: { subsite: s.id },
      props: { subsiteInfo: s },
    }));
}

const { subsite } = Astro.params;

const projectRoot = path.resolve(fileURLToPath(new URL('../../../../', import.meta.url)));
const contentRoot = path.join(projectRoot, 'content');
const citationDir = path.join(contentRoot, subsite, 'citations');

function toYear(item: any) {
  const parts = item?.issued?.['date-parts']?.[0];
  if (Array.isArray(parts) && parts[0]) return parts[0];
  return undefined;
}

function toAuthors(item: any) {
  const authors = item?.author;
  if (!Array.isArray(authors)) return undefined;
  return authors
    .map((a) => {
      const family = a.family || a.literal || '';
      const given = a.given || '';
      return [family, given].filter(Boolean).join(', ');
    })
    .filter(Boolean)
    .join('; ');
}

function toUrl(item: any) {
  const doi = item?.DOI || item?.doi;
  if (doi) return `https://doi.org/${doi}`;
  if (item?.URL) return item.URL;
  if (item?.url) return item.url;
  return undefined;
}

async function loadCitations() {
  try {
    await fs.promises.access(citationDir);
  } catch {
    return { exists: false, citations: [] };
  }

  const files = (await fs.promises.readdir(citationDir)).filter((f) => f.toLowerCase().endsWith('.bib'));
  if (files.length === 0) {
    return { exists: true, citations: [] };
  }

  const citations: Array<{
    title?: string;
    authors?: string;
    year?: number;
    url?: string;
    raw: any;
  }> = [];
  for (const file of files) {
    const text = await fs.promises.readFile(path.join(citationDir, file), 'utf8');
    const cite = new Cite(text);
    for (const item of cite.data) {
      citations.push({
        title: item.title,
        authors: toAuthors(item),
        year: toYear(item),
        url: toUrl(item),
        raw: item,
      });
    }
  }

  citations.sort((a, b) => (b.year || 0) - (a.year || 0));
  return { exists: true, citations };
}

const { exists, citations } = await loadCitations();
const yearCounts = citations.reduce(
  (acc, citation) => {
    const key = citation.year ? String(citation.year) : 'unknown';
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>
);
const years = Object.keys(yearCounts).sort((a, b) => {
  if (a === 'unknown') return 1;
  if (b === 'unknown') return -1;
  return Number(b) - Number(a);
});
const emptyHint = `No citations found for ${subsite}. Add a BibTeX file at content/${subsite}/citations/.`;
---

<BaseLayout
  title={`Scientific research using & citing the ${subsite.toUpperCase()} Galaxy server`}
  description={`Scientific research using & citing the ${subsite.toUpperCase()} Galaxy server.`}
>
  <div class="max-w-5xl mx-auto space-y-6">
    <header class="border-b border-gray-200 pb-4">
      <h1 class="text-3xl font-bold text-galaxy-dark">{subsite.toUpperCase()} Citations</h1>
      <p class="text-gray-600">
        This is the list of scientific publications that cited the {subsite.toUpperCase()} Galaxy instance. Please help us
        to support this project with your acknowledgement.
      </p>
    </header>

    {
      !exists || citations.length === 0 ? (
        <div class="rounded-md border border-dashed border-gray-300 bg-gray-50 p-6 text-gray-700">
          <p>{emptyHint}</p>
        </div>
      ) : (
        <div class="space-y-6">
          <section class="rounded-md border border-gray-200 bg-gray-50 p-4 space-y-3">
            <p class="text-sm text-gray-700 font-medium">Filter by year</p>
            <div class="flex flex-wrap items-center gap-2">
              <a
                data-year-button
                data-year="all"
                href="."
                class="px-3 py-1.5 text-sm font-medium rounded-md bg-galaxy-primary text-white"
                aria-pressed="true"
              >
                All <span class="ml-1 text-xs opacity-80">({citations.length})</span>
              </a>
              {years.map((year) => (
                <a
                  data-year-button
                  data-year={year}
                  href={`?year=${encodeURIComponent(year)}`}
                  class="px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200"
                  aria-pressed="false"
                >
                  {year === 'unknown' ? 'Unknown year' : year}
                  <span class="ml-1 text-xs opacity-80">({yearCounts[year]})</span>
                </a>
              ))}
            </div>
            <p class="text-sm text-gray-500" data-filter-count>
              Showing {citations.length} citation{citations.length === 1 ? '' : 's'}
            </p>
          </section>

          {citations.map((c, idx) => (
            <article
              class="border border-gray-200 rounded-md p-4 shadow-sm"
              key={`${c.title || 'citation'}-${idx}`}
              data-citation-year={c.year ? String(c.year) : 'unknown'}
            >
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h2 class="text-lg font-semibold text-galaxy-dark">
                    {c.url ? (
                      <a
                        href={c.url}
                        class="hover:text-galaxy-primary transition-colors"
                        target="_blank"
                        rel="noopener noreferrer"
                        set:html={c.title || 'Untitled'}
                      />
                    ) : (
                      <span set:html={c.title || 'Untitled'} />
                    )}
                  </h2>
                  {c.authors && <p class="text-sm text-gray-600 mt-1">{c.authors}</p>}
                </div>
              </div>
            </article>
          ))}
        </div>
      )
    }
  </div>

  <script>
    (() => {
      const buttons = Array.from(document.querySelectorAll('[data-year-button]'));
      const items = Array.from(document.querySelectorAll('[data-citation-year]'));
      const countEl = document.querySelector('[data-filter-count]');

      function applyFilter(year) {
        let visible = 0;

        items.forEach((item) => {
          const itemYear = item.dataset.citationYear || 'unknown';
          const matches = year === 'all' ? true : itemYear === year;
          item.classList.toggle('hidden', !matches);
          if (matches) visible += 1;
        });

        buttons.forEach((btn) => {
          const isActive = (btn.dataset.year || 'all') === year;
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          btn.classList.toggle('bg-galaxy-primary', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('bg-gray-100', !isActive);
          btn.classList.toggle('text-gray-700', !isActive);
        });

        if (countEl) {
          const label = year === 'all' ? 'citations' : `citations for ${year === 'unknown' ? 'Unknown year' : year}`;
          countEl.textContent = `Showing ${visible} ${label}`;
        }

        const params = new URLSearchParams(window.location.search);
        if (year === 'all') {
          params.delete('year');
        } else {
          params.set('year', year);
        }
        const newUrl = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ''}`;
        window.history.pushState({}, '', newUrl);
      }

      const searchParams = new URLSearchParams(window.location.search);
      const initialYear = (() => {
        const fromQuery = searchParams.get('year');
        if (!fromQuery) return 'all';
        const normalized = fromQuery.toLowerCase() === 'unknown' ? 'unknown' : fromQuery;
        return buttons.some((b) => (b.dataset.year || '') === normalized) ? normalized : 'all';
      })();

      buttons.forEach((btn) => {
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          applyFilter(btn.dataset.year || 'all');
        });
      });

      applyFilter(initialYear);
    })();
  </script>
</BaseLayout>
