---
import { render } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { getPublishedNews } from '../../utils/content';

// Import MDX components for embedded content
import VegaEmbed from '../../components/mdx/VegaEmbed.astro';
import Twitter from '../../components/mdx/Twitter.astro';
import Mastodon from '../../components/mdx/Mastodon.astro';
import VideoPlayer from '../../components/mdx/VideoPlayer.astro';
import Carousel from '../../components/mdx/Carousel.astro';
import CalendarEmbed from '../../components/mdx/CalendarEmbed.astro';
import MarkdownEmbed from '../../components/mdx/MarkdownEmbed.astro';
import Flickr from '../../components/mdx/Flickr.astro';
import Supporters from '../../components/mdx/Supporters.astro';
import Contacts from '../../components/mdx/Contacts.astro';
import Insert from '../../components/mdx/Insert.astro';
import { resolveSupporters } from '../../utils/supporters';

export async function getStaticPaths() {
  // Get only published news articles (excludes future-dated articles)
  const newsArticles = await getPublishedNews();

  return newsArticles.map((article) => {
    // Remove 'news/' prefix from slug for the URL
    const urlSlug = article.data.slug.replace(/^news\//, '');
    return {
      params: { slug: urlSlug },
      props: { article },
    };
  });
}

const { article } = Astro.props;
const { Content } = await render(article);

const { title, date, authors = [], tags = [], tease, image, external_url } = article.data;
if (external_url) {
  return Astro.redirect(external_url);
}
const supporters = await resolveSupporters((article as any).data.supporters);

// MDX components map
const components = {
  VegaEmbed,
  Twitter,
  Mastodon,
  VideoPlayer,
  Carousel,
  CalendarEmbed,
  MarkdownEmbed,
  Flickr,
  Supporters,
  Contacts,
  Insert,
};
---

<ArticleLayout
  title={title || 'News'}
  description={tease}
  date={date}
  authors={authors}
  tags={tags}
  image={image}
  supporters={supporters}
  backLink={{ href: '/news/', label: 'Back to News' }}
>
  <Content components={components} />
</ArticleLayout>
