---
import { render } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { getPublishedNews } from '../../utils/content';

// Import MDX components for embedded content
import VegaEmbed from '../../components/mdx/VegaEmbed.astro';
import Twitter from '../../components/mdx/Twitter.astro';
import Mastodon from '../../components/mdx/Mastodon.astro';
import VideoPlayer from '../../components/mdx/VideoPlayer.astro';
import Carousel from '../../components/mdx/Carousel.astro';
import CalendarEmbed from '../../components/mdx/CalendarEmbed.astro';
import MarkdownEmbed from '../../components/mdx/MarkdownEmbed.astro';
import Flickr from '../../components/mdx/Flickr.astro';
import Supporters from '../../components/mdx/Supporters.astro';
import Contacts from '../../components/mdx/Contacts.astro';
import Insert from '../../components/mdx/Insert.astro';
import { resolveSupporters } from '../../utils/supporters';
import { getContributor } from '../../utils/contributors';

export async function getStaticPaths() {
  // Get only published news articles (excludes future-dated articles)
  const newsArticles = await getPublishedNews();

  return newsArticles.map((article) => {
    // Remove 'news/' prefix from slug for the URL
    const urlSlug = article.data.slug.replace(/^news\//, '');
    return {
      params: { slug: urlSlug },
      props: { article },
    };
  });
}

const { article } = Astro.props;
const { Content, headings } = await render(article);

const toArray = (value: unknown): string[] => {
  if (!value) return [];
  if (Array.isArray(value)) return value.flatMap((v) => toArray(v));
  if (typeof value === 'object') {
    const obj = value as Record<string, any>;
    if (obj.name) return [String(obj.name)];
    return [];
  }
  return [String(value)];
};

const contributions = (article as any).data.contributions || {};
const contributionAuthors = [
  ...toArray(contributions.authorship),
  ...toArray(contributions.authors),
  ...toArray(contributions.author),
  ...toArray(contributions.contributors),
].filter(Boolean);

const contributionFunding = [
  ...toArray(contributions.funding),
  ...toArray((article as any).data.infrastructure),
  ...toArray((article as any).data.data),
].filter(Boolean);

const rawAuthors = toArray((article as any).data.authors);

const resolveAuthor = (value: string) => {
  const contributor = getContributor(value);
  if (contributor) {
    return { id: contributor.id, name: contributor.name || contributor.id };
  }
  return { name: value };
};

const displayAuthorsDetailed =
  contributionAuthors.length > 0
    ? contributionAuthors.map((id: string) => resolveAuthor(id))
    : rawAuthors.map((name: string) => resolveAuthor(name));

const { title, date, tags = [], tease, image, external_url, autotoc } = article.data;
if (external_url) {
  return Astro.redirect(external_url);
}
const supporterSource =
  contributionFunding.length > 0 ? contributionFunding : (article as any).data.supporters || (article as any).data.funding;
const supporters = await resolveSupporters(supporterSource);

// MDX components map
const components = {
  VegaEmbed,
  Twitter,
  Mastodon,
  VideoPlayer,
  Carousel,
  CalendarEmbed,
  MarkdownEmbed,
  Flickr,
  Supporters,
  Contacts,
  Insert,
};

// Schema.org structured data
const site = Astro.site?.toString().replace(/\/$/, '') || 'https://galaxyproject.org';
const canonical = `${site}/${article.data.slug.replace(/^\/|\/$/g, '')}/`;
const published = date ? new Date(date) : null;
const authorList = (displayAuthorsDetailed || []).map((entry: { name: string }) => ({
  '@type': 'Person',
  name: entry.name,
}));
const imageUrl = image ? (image.startsWith('http') ? image : `${site}${image}`) : undefined;

const schemaNews = {
  '@context': 'https://schema.org',
  '@type': 'NewsArticle',
  headline: title || 'News',
  description: tease || undefined,
  datePublished: published ? published.toISOString() : undefined,
  dateModified: published ? published.toISOString() : undefined,
  url: canonical,
  mainEntityOfPage: canonical,
  author: authorList.length > 0 ? authorList : undefined,
  publisher: {
    '@type': 'Organization',
    name: 'Galaxy Project',
    url: 'https://galaxyproject.org',
    logo: {
      '@type': 'ImageObject',
      url: `${site}/images/galaxy_logo_hub_white.svg`,
    },
  },
  image: imageUrl,
};
---

<ArticleLayout
  title={title || 'News'}
  description={tease}
  date={date}
  authors={displayAuthorsDetailed}
  tags={tags}
  image={image}
  headings={headings}
  autotoc={autotoc}
  supporters={supporters}
  backLink={{ href: '/news/', label: 'Back to News' }}
  sourceFile={article.data.slug}
>
  <Content components={components} />
  <script type="application/ld+json" is:inline set:html={JSON.stringify(schemaNews)} />
</ArticleLayout>
