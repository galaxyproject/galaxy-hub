---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Default.astro';
import { format } from 'date-fns';

// Get all events
const allEvents = await getCollection('events');

// Sort events by date (upcoming first, then past)
const now = new Date();
const upcomingEvents = allEvents
  .filter(event => new Date(event.data.date) >= now)
  .sort((a, b) => new Date(a.data.date) - new Date(b.data.date));

const pastEvents = allEvents
  .filter(event => new Date(event.data.date) < now)
  .sort((a, b) => new Date(b.data.date) - new Date(a.data.date))
  .slice(0, 50); // Show only recent past events

// Group events by month for upcoming events
const eventsByMonth = upcomingEvents.reduce((acc, event) => {
  const monthKey = format(new Date(event.data.date), 'MMMM yyyy');
  if (!acc[monthKey]) acc[monthKey] = [];
  acc[monthKey].push(event);
  return acc;
}, {});
---

<Layout title="Galaxy Events">
  <div class="container my-5">
    <div class="row">
      <div class="col-lg-9">
        <h1>Galaxy Events</h1>
        
        <p class="lead">
          Galaxy events are geographically diverse and cover a wide range of topics. 
          Events are offered mainly by the Galaxy community, but also by Galaxy project team members.
        </p>

        <div class="alert alert-info">
          <strong>Add Your Event!</strong> 
          Is there an event that should be added to this page? 
          Please <a href="https://github.com/galaxyproject/galaxy-hub/issues/new">open an issue</a> or 
          submit a pull request to add it.
        </div>

        <h2 class="mt-5">Upcoming Events</h2>
        {Object.keys(eventsByMonth).length === 0 ? (
          <p class="text-muted">No upcoming events scheduled.</p>
        ) : (
          Object.entries(eventsByMonth).map(([month, events]) => (
            <div class="mb-4">
              <h3>{month}</h3>
              <div class="list-group">
                {events.map(event => (
                  <a href={`/${event.data.slug}`} class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                      <h5 class="mb-1">{event.data.title}</h5>
                      <small>{format(new Date(event.data.date), 'MMM d')}</small>
                    </div>
                    {event.data.tease && (
                      <p class="mb-1">{event.data.tease}</p>
                    )}
                    <div class="d-flex justify-content-between">
                      <small>
                        {event.data.location && (
                          typeof event.data.location === 'string' 
                            ? event.data.location 
                            : event.data.location.name
                        )}
                      </small>
                      {event.data.tags && (
                        <small>
                          {event.data.tags.map(tag => (
                            <span class="badge badge-secondary mr-1">{tag}</span>
                          ))}
                        </small>
                      )}
                    </div>
                  </a>
                ))}
              </div>
            </div>
          ))
        )}

        <h2 class="mt-5">Recent Past Events</h2>
        <div class="list-group">
          {pastEvents.map(event => (
            <a href={`/${event.data.slug}`} class="list-group-item list-group-item-action">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{event.data.title}</h6>
                <small class="text-muted">{format(new Date(event.data.date), 'MMM d, yyyy')}</small>
              </div>
            </a>
          ))}
        </div>

        <div class="mt-4">
          <a href="/events/archive" class="btn btn-secondary">View All Past Events</a>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Event Series</h5>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li><a href="/events/webinars">Galaxy Webinars</a></li>
              <li><a href="/events/cofests">CoFests</a></li>
              <li><a href="/events/dev-roundtable">Dev Roundtables</a></li>
              <li><a href="/events/community-call">Community Calls</a></li>
              <li><a href="/gcc">Galaxy Community Conference</a></li>
            </ul>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Resources</h5>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li><a href="/events/calendar">Calendar Feed</a></li>
              <li><a href="/events/archive">Event Archive</a></li>
              <li><a href="https://training.galaxyproject.org">Training Materials</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>