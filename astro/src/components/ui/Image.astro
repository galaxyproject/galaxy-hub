---
/**
 * Simplified optimized Image component. Images must be located in the /src/assets/ directory to be optimized. Uses Picture component for better browser compatibility with format fallbacks. Works for the following Astro asset types:
 * (1) Markdown (.MD) for Frontmatter image only - the default size
 * (2) Astro (.Astro) file images
 */
import { Picture } from 'astro:assets';

const OPTIMIZED_PERCENT = 90;  // [90, 80, 75]
const FRONTMATTER = {
  width: 1088,
  class: 'w-full h-auto',
};

interface Props {
  src: string | null | undefined;
  alt: string;
  title?: string;
  width?: number;
  height?: number;
  class?: string;
  quality?: number;
}

const { 
  src, 
  alt, 
  title, 
  width = FRONTMATTER.width, 
  height, 
  class: className = FRONTMATTER.class,
  quality = OPTIMIZED_PERCENT
} = Astro.props;

// Import all assets dynamically
const allAssets = import.meta.glob('/src/assets/**/*.{png,jpg,jpeg,gif,webp,svg}', { eager: true });

const assetModule = src ? allAssets[src] : null;
const assetImage = assetModule ? (assetModule as any)?.default || assetModule : null;
const calculatedHeight = calculateHeight(height, assetImage, width);

function calculateHeight(height: number | undefined, assetImage: any, width: number): number {
  let calculatedHeight = height;
  if (!height && assetImage) {
    const aspectRatio = assetImage.height / assetImage.width;
    calculatedHeight = Math.round(width * aspectRatio);
  }
  return calculatedHeight!;
}
---

{src && (
  <span>
    {assetImage ? (
      /* Optimized image */
      <Picture
        src={assetImage}
        alt={alt}
        title={title}
        width={width}
        height={calculatedHeight}
        class={className}
        formats={['webp', 'avif']}
        fallbackFormat="png"
        quality={quality}
        loading="lazy"
      />
    ) : (
      /* External or non-asset image */
      <img 
        src={src}
        alt={alt}
        title={title}
        class={className}
        loading="lazy"
        decoding="async"
      />
    )}
  </span>
)}
