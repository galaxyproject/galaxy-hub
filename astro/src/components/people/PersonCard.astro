---
import type { PersonProfile } from '../../utils/people';
import { socialIconMap, type SocialIconName } from '../../utils/socialIcons';
import { marked } from 'marked';

interface Props {
  person: PersonProfile;
  hallOfFameUrl?: string;
}

const { person, hallOfFameUrl } = Astro.props;

const avatar =
  person.avatarUrl || (person.github ? `https://avatars.githubusercontent.com/${person.github}?s=240` : undefined);
const githubUrl = person.github ? `https://github.com/${person.github}` : undefined;
const websiteUrl = person.website;
const gtnUrl = person.gtnProfile;
const bioHtml = person.bio ? marked.parse(person.bio) : '';

type Row = { icon: 'email' | 'phone' | 'location' | 'website'; label: string; href?: string };
const rows: Row[] = [];
if (person.email) rows.push({ icon: 'email', label: person.email, href: `mailto:${person.email}` });
if (person.phone)
  rows.push({ icon: 'phone', label: person.phone, href: `tel:${person.phone.replace(/[^0-9+]/g, '')}` });
if (person.location) rows.push({ icon: 'location', label: person.location, href: person.locationLink });
if (websiteUrl) rows.push({ icon: 'website', label: 'Website', href: websiteUrl });

const socialLinks: Array<{ label: string; href: string; icon: SocialIconName }> = [];
if (person.mastodon) socialLinks.push({ label: 'Fediverse', href: person.mastodon, icon: 'fediverse' });
if (person.linkedin)
  socialLinks.push({ label: 'LinkedIn', href: `https://www.linkedin.com/in/${person.linkedin}`, icon: 'linkedin' });
const matrixHandle = person.matrix?.replace(/^https?:\/\/matrix\.to\/#!?\//, '');
if (person.matrix)
  socialLinks.push({ label: 'Matrix', href: `https://matrix.to/#/${matrixHandle || person.matrix}`, icon: 'matrix' });
if (person.orcid) socialLinks.push({ label: 'ORCID', href: `https://orcid.org/${person.orcid}`, icon: 'orcid' });
if (person.googleScholar)
  socialLinks.push({
    label: 'Google Scholar',
    href: `https://scholar.google.com/citations?user=${person.googleScholar}`,
    icon: 'google-scholar',
  });
if (person.researchgate)
  socialLinks.push({
    label: 'ResearchGate',
    href: `https://www.researchgate.net/profile/${person.researchgate}`,
    icon: 'researchgate',
  });
if (gtnUrl) socialLinks.push({ label: 'GTN Profile', href: gtnUrl, icon: 'gtn' });
if (person.github && githubUrl) socialLinks.push({ label: 'GitHub', href: githubUrl, icon: 'github' });
---

<article
  class="relative rounded-xl border border-gray-200 bg-white shadow-sm transition-transform duration-200 hover:-translate-y-1 hover:shadow-lg text-center p-6 pt-14 overflow-visible"
>
  {
    hallOfFameUrl && (
      <a
        href={hallOfFameUrl}
        class="absolute top-3 right-3 z-10 inline-flex items-center justify-center rounded-md border border-white/40 bg-gradient-to-r from-galaxy-dark to-galaxy-primary px-3 py-1 text-[11px] font-semibold text-white shadow-md -rotate-3"
        aria-label="Hub Contributions profile"
      >
        Hub Contributions
      </a>
    )
  }
  <div
    class="absolute -top-12 left-1/2 -translate-x-1/2 h-20 w-20 rounded-full ring-4 ring-white shadow-md overflow-hidden bg-gray-100"
  >
    {
      avatar ? (
        <img src={avatar} alt={person.name} class="h-full w-full object-cover" loading="lazy" />
      ) : (
        <div class="h-full w-full flex items-center justify-center text-lg font-semibold text-galaxy-primary">
          {(person.name || person.id || '?').slice(0, 2).toUpperCase()}
        </div>
      )
    }
  </div>

  <div class="space-y-2">
    <div class="space-y-1">
      <h3 class="text-lg font-semibold text-galaxy-dark mt-2">{person.name}</h3>
      {person.title && <p class="text-sm text-gray-600">{person.title}</p>}
    </div>
    {bioHtml && <div class="pt-1 prose prose-sm max-w-none text-left mx-auto" set:html={bioHtml} />}
  </div>

  <div class="mt-4 space-y-2">
    {
      rows.map((row) =>
        row.href ? (
          <a
            href={row.href}
            class="flex items-center justify-center gap-2 text-sm text-galaxy-primary hover:text-galaxy-dark transition-colors"
            target={row.href.startsWith('http') ? '_blank' : undefined}
            rel={row.href.startsWith('http') ? 'noopener noreferrer' : undefined}
          >
            {row.icon === 'email' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"
                />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m22 6-10 7L2 6" />
              </svg>
            ) : row.icon === 'github' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox={socialIconMap.github.viewBox}>
                <path d={socialIconMap.github.path} fill="currentColor" transform={socialIconMap.github.transform} />
              </svg>
            ) : row.icon === 'phone' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 5a2 2 0 012-2h1.28a1 1 0 01.95.68l1.22 3.66a1 1 0 01-.27 1.05L7.1 9.9a11.05 11.05 0 005 5l1.51-1.53a1 1 0 011.05-.27l3.66 1.22a1 1 0 01.68.95V19a2 2 0 01-2 2h-1C9.163 21 3 14.837 3 7V5z"
                />
              </svg>
            ) : row.icon === 'website' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3a9 9 0 100 18 9 9 0 000-18z"
                />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18" />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3c2.5 2.3 3.9 5.6 4 9-.1 3.4-1.5 6.7-4 9-2.5-2.3-3.9-5.6-4-9 .1-3.4 1.5-6.7 4-9z"
                />
              </svg>
            ) : row.icon === 'location' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 11c1.38 0 2.5-1.12 2.5-2.5S13.38 6 12 6s-2.5 1.12-2.5 2.5S10.62 11 12 11z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19.5 9.5c0 7-7.5 11-7.5 11S4.5 16.5 4.5 9.5a7.5 7.5 0 1115 0z"
                />
              </svg>
            ) : (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            )}
            <span class="break-words">{row.label}</span>
          </a>
        ) : (
          <div class="flex items-center justify-center gap-2 text-sm text-gray-700">
            {row.icon === 'email' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"
                />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m22 6-10 7L2 6" />
              </svg>
            ) : row.icon === 'github' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox={socialIconMap.github.viewBox}>
                <path d={socialIconMap.github.path} fill="currentColor" transform={socialIconMap.github.transform} />
              </svg>
            ) : row.icon === 'phone' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 5a2 2 0 012-2h1.28a1 1 0 01.95.68l1.22 3.66a1 1 0 01-.27 1.05L7.1 9.9a11.05 11.05 0 005 5l1.51-1.53a1 1 0 011.05-.27l3.66 1.22a1 1 0 01.68.95V19a2 2 0 01-2 2h-1C9.163 21 3 14.837 3 7V5z"
                />
              </svg>
            ) : row.icon === 'website' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3a9 9 0 100 18 9 9 0 000-18z"
                />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18" />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3c2.5 2.3 3.9 5.6 4 9-.1 3.4-1.5 6.7-4 9-2.5-2.3-3.9-5.6-4-9 .1-3.4 1.5-6.7 4-9z"
                />
              </svg>
            ) : row.icon === 'location' ? (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 11c1.38 0 2.5-1.12 2.5-2.5S13.38 6 12 6s-2.5 1.12-2.5 2.5S10.62 11 12 11z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19.5 9.5c0 7-7.5 11-7.5 11S4.5 16.5 4.5 9.5a7.5 7.5 0 1115 0z"
                />
              </svg>
            ) : (
              <svg class="h-4 w-4 text-galaxy-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            )}
            <span class="break-words">{row.label}</span>
          </div>
        )
      )
    }
  </div>

  {
    socialLinks.length > 0 && (
      <div class="mt-4 flex flex-wrap justify-center gap-2">
        {socialLinks.map((link) => (
          <a
            href={link.href}
            class="inline-flex items-center justify-center h-9 w-9 rounded-full border border-gray-200 text-galaxy-primary bg-white hover:bg-galaxy-primary/10 hover:border-galaxy-primary transition-colors shadow-sm"
            target="_blank"
            rel="noopener noreferrer"
            title={link.label}
            aria-label={link.label}
          >
            {socialIconMap[link.icon]?.path ? (
              <svg class="h-4 w-4" viewBox={socialIconMap[link.icon].viewBox} aria-hidden="true" focusable="false">
                <path
                  d={socialIconMap[link.icon].path}
                  fill="currentColor"
                  transform={socialIconMap[link.icon].transform}
                />
              </svg>
            ) : socialIconMap[link.icon]?.imgSrc ? (
              <img src={socialIconMap[link.icon].imgSrc} alt="" class="h-4 w-4" loading="lazy" />
            ) : null}
          </a>
        ))}
      </div>
    )
  }
</article>
