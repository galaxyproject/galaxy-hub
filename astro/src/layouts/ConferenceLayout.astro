---
import BaseLayout from './BaseLayout.astro';
import PageHeader from '../components/layout/PageHeader.astro';
import ContentWithToc from '../components/layout/ContentWithToc.astro';
import SupporterGrid from '../components/content/SupporterGrid.astro';
import Icon from '../components/ui/Icon.astro';
import type { SupporterProfile } from '../utils/supporters';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Contact {
  name?: string;
  email?: string;
}

interface LocationData {
  name?: string;
  city?: string;
  country?: string;
}

interface Props {
  title: string;
  description?: string;
  tags?: string[];
  authors?: Array<string | { id?: string; name: string }>;
  date?: Date | string;
  end?: Date | string;
  location?: string | LocationData | null;
  contacts?: Contact[];
  autotoc?: boolean;
  headings?: Heading[];
  supporters?: SupporterProfile[];
  editUrl: string;
  externalUrl?: string | null;
  showMetadata?: boolean;
  subnavItems?: Array<{ href: string; label: string; active?: boolean }>;
}

const {
  title,
  description,
  tags = [],
  authors = [],
  date,
  end,
  location,
  contacts = [],
  autotoc = false,
  headings = [],
  supporters = [],
  editUrl,
  externalUrl,
  showMetadata = true,
  subnavItems = [],
} = Astro.props;

function toDate(d: Date | string | undefined): Date | null {
  if (!d) return null;
  return d instanceof Date ? d : new Date(d);
}

function formatDate(dateValue: Date | string | undefined): string {
  const d = toDate(dateValue);
  if (!d) return '';
  return d.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    timeZone: 'UTC',
  });
}

function formatDateRange(start: Date | string | undefined, endDate?: Date | string): string {
  const startD = toDate(start);
  const endD = toDate(endDate);
  if (!startD) return '';
  if (!endD || startD.getTime() === endD.getTime()) {
    return formatDate(startD);
  }
  return `${formatDate(startD)} - ${formatDate(endD)}`;
}

function toISOString(d: Date | string | undefined): string {
  const dateObj = toDate(d);
  return dateObj ? dateObj.toISOString() : '';
}

function getLocationText(loc: string | LocationData | null | undefined): string {
  if (!loc) return '';
  if (typeof loc === 'string') return loc;
  const parts = [loc.name, loc.city, loc.country].filter(Boolean);
  return parts.join(', ');
}

const hasMetadata =
  showMetadata &&
  ((title && title !== 'Event') ||
    description ||
    date ||
    location ||
    tags.length > 0 ||
    authors.length > 0 ||
    contacts.length > 0);
---

<BaseLayout title={title || 'Conference'} description={description}>
  <article class="max-w-6xl mx-auto bg-white relative">
    {
      hasMetadata && (
        <PageHeader title={title || 'Conference'} description={description} tags={tags} authors={authors}>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm mt-4">
            {date && (
              <div class="flex items-start gap-3 text-white/80">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-galaxy-gold flex-shrink-0 mt-0.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                <div>
                  <span class="block font-medium text-white">Date</span>
                  <time datetime={toISOString(date)}>{formatDateRange(date, end)}</time>
                </div>
              </div>
            )}

            {location && (
              <div class="flex items-start gap-3 text-white/80">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-galaxy-gold flex-shrink-0 mt-0.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <div>
                  <span class="block font-medium text-white">Location</span>
                  <span>{getLocationText(location)}</span>
                </div>
              </div>
            )}

            {contacts.length > 0 && (
              <div class="flex items-start gap-3 text-white/80">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-galaxy-gold flex-shrink-0 mt-0.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
                <div>
                  <span class="block font-medium text-white">Contact</span>
                  <span>
                    {contacts
                      .map((c) => c.name || c.email)
                      .filter(Boolean)
                      .join(', ')}
                  </span>
                </div>
              </div>
            )}
          </div>
          {subnavItems.length > 0 && (
            <nav class="conference-subnav" aria-label="Conference pages">
              {subnavItems.map((item) => (
                <a href={item.href} class:list={['conference-subnav-link', item.active && 'is-active']}>
                  {item.label}
                </a>
              ))}
            </nav>
          )}
        </PageHeader>
      )
    }

    <ContentWithToc headings={headings} autotoc={autotoc}>
      <slot />
    </ContentWithToc>

    <footer class="px-6 sm:px-8 pb-6 sm:pb-8 mt-8">
      {
        supporters.length > 0 && (
          <div class="mb-6">
            <SupporterGrid supporters={supporters} title="Supporters" />
          </div>
        )
      }
      <div class="flex justify-between items-center pt-4 border-t border-gray-200">
        <a
          href="/events/"
          class="text-galaxy-primary hover:text-galaxy-gold flex items-center gap-1.5 font-medium transition-colors"
        >
          <Icon name="chevron-left" />
          Back to Events
        </a>
        <div class="flex items-center gap-4">
          <a
            href={editUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="text-gray-500 hover:text-galaxy-primary flex items-center gap-1.5 transition-colors"
          >
            <Icon name="edit" />
            Edit on GitHub
          </a>
          {
            externalUrl && (
              <a
                href={externalUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-4 py-2 bg-galaxy-primary text-white rounded-md hover:bg-galaxy-primary/90 transition-colors"
              >
                Visit Event Website
                <Icon name="external-link" />
              </a>
            )
          }
        </div>
      </div>
    </footer>

    <slot name="extra" />
  </article>
</BaseLayout>

<style>
  .conference-subnav {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
  }

  .conference-subnav-link {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.35);
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
    line-height: 1.25rem;
    text-decoration: none;
    transition:
      border-color 0.2s ease,
      color 0.2s ease,
      background-color 0.2s ease;
  }

  .conference-subnav-link:hover {
    border-color: var(--color-galaxy-gold);
    color: #fff;
    background: rgba(255, 255, 255, 0.08);
  }

  .conference-subnav-link.is-active {
    border-color: var(--color-galaxy-gold);
    background: rgba(244, 208, 63, 0.2);
    color: #fff;
    font-weight: 600;
  }
</style>
